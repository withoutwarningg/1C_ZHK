
Процедура РассчитатьИЗаполнитьНаСервере()

		Объект.ТабЧасть.Очистить();
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ЛицевыеСчета.Ссылка КАК ЛицевойСчет,
	|	ТарифыЖКХ.НаименованиеУслуги КАК Услуга,
	|	ТарифыЖКХ.ЦенаЗаЕдиницу * &КоличествоЕдиниц КАК Сумма
	|ИЗ
	|	Справочник.ЛицевыеСчета КАК ЛицевыеСчета
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТарифыЖКХ КАК ТарифыЖКХ
	|	ПО (ТарифыЖКХ.НаименованиеУслуги = ЛицевыеСчета.НАзначенныеУслуги.Услуга)
	|ГДЕ
	|	(НЕ ЛицевыеСчета.Ссылка В 
	|		(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|			ТабЧастьРасчетов.ЛицевойСчет
	|		ИЗ
	|			Документ.РасчетНачислений.ТабЧасть КАК ТабЧастьРасчетов
	|		ГДЕ
	|			ТабЧастьРасчетов.Ссылка.Проведен = ИСТИНА
	|			И ТабЧастьРасчетов.Ссылка.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца))
	|	И (НЕ &ЕстьОтборПоДому ИЛИ ЛицевыеСчета.Дом = &Дом)");
	
	Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("КонецМесяца", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("ЕстьОтборПоДому", ЗначениеЗаполнено(Объект.Дом));
	Запрос.УстановитьПараметр("Дом", Объект.Дом);
	Запрос.УстановитьПараметр("КоличествоЕдиниц", 1);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.ТабЧасть.Добавить();
		НоваяСтрока.ЛицевойСчет = Выборка.ЛицевойСчет;
		НоваяСтрока.Услуга = Выборка.Услуга;
		НоваяСтрока.КоличествоЕдиниц = 1;
		НоваяСтрока.СуммаНачислений = Выборка.Сумма;
		НоваяСтрока.ДатаПериодаЗадолженности = НачалоМесяца(Объект.Дата);
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИЗаполнить(Команда)
	РассчитатьИЗаполнитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ТабЧастьКоличествоЕдиницПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.ТабЧасть.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ИдентификаторСтроки = ТекущаяСтрока.ПолучитьИдентификатор();
	РассчитатьСуммуСтрокиНаСервере(ИдентификаторСтроки);	
КонецПроцедуры

&НаСервере
Процедура РассчитатьСуммуСтрокиНаСервере(ИдентификаторСтроки)
	
	СтрокаТабличнойЧасти = Объект.ТабЧасть.НайтиПоИдентификатору(ИдентификаторСтроки);
	
	Если СтрокаТабличнойЧасти = Неопределено Или СтрокаТабличнойЧасти.Услуга = Неопределено Тогда
		СтрокаТабличнойЧасти.Сумма = 0;
		Возврат;
	КонецЕсли;
	
	Тариф = 0;
	ЗапросТарифа = Новый Запрос(
	"ВЫБРАТЬ
	|	ТарифыЖКХ.ЦенаЗаЕдиницу КАК Тариф
	|ИЗ
	|	Справочник.ТарифыЖКХ КАК ТарифыЖКХ
	|ГДЕ
	|	ТарифыЖКХ.НаименованиеУслуги = &Услуга");
	
	ЗапросТарифа.УстановитьПараметр("Услуга", СтрокаТабличнойЧасти.Услуга);
	РезультатЗапроса = ЗапросТарифа.Выполнить();
	
	Если Не РезультатЗапроса.Пустой() Тогда
		ВыборкаТарифа = РезультатЗапроса.Выбрать();
		ВыборкаТарифа.Следующий();
		Тариф = ВыборкаТарифа.Тариф;
	КонецЕсли;
	
	СтрокаТабличнойЧасти.СуммаНачислений = СтрокаТабличнойЧасти.КоличествоЕдиниц * Тариф;	
КонецПроцедуры